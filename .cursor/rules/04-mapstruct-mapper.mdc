---
description: MapStruct mapper patterns - MANDATORY for all mappers
globs: 
alwaysApply: true
---

# MapStruct Mapper Patterns - MANDATORY

> **PRIORITY: HIGH** - All mapper configurations shown here are MANDATORY.

## Standard Mapper Template (COPY EXACTLY)

```java
@Mapper(
    componentModel = "spring",
    unmappedTargetPolicy = ReportingPolicy.IGNORE,
    nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE
)
public interface {Entity}Mapper {

    // Entity -> Response DTO
    {Entity}ResponseDto toResponseDto({Entity} entity);
    
    // Request DTO -> Entity (for CREATE)
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    @Mapping(target = "version", ignore = true)
    @Mapping(target = "status", constant = "PENDING")
    {Entity} toEntity(Create{Entity}RequestDto requestDto);
    
    // Update entity from DTO (for UPDATE - PARTIAL)
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    @Mapping(target = "version", ignore = true)
    @Mapping(target = "customerId", ignore = true)  // Immutable field
    void updateEntityFromDto(@MappingTarget {Entity} entity, Update{Entity}RequestDto updateDto);
}
```

## ⛔ FORBIDDEN Patterns

```java
// ❌ WRONG - Missing policies
@Mapper(componentModel = "spring")
public interface BookingMapper {

// ❌ WRONG - Missing updateEntityFromDto method
// Every mapper MUST have all 3 methods: toResponseDto, toEntity, updateEntityFromDto

// ❌ WRONG - Manual update in service
public BookingResponseDto update(Long id, UpdateBookingRequestDto request) {
    Booking booking = repository.findById(id).orElseThrow(...);
    if (request.getCheckInDate() != null) {
        booking.setCheckInDate(request.getCheckInDate());  // FORBIDDEN
    }
    // ...
}
```

## ✅ CORRECT Update Pattern

```java
// In Service - use mapper for updates
@Override
@Transactional
public BookingResponseDto update(Long id, UpdateBookingRequestDto request) {
    log.debug("Updating booking with id: {}", id);
    
    var entity = bookingRepository.findById(id)
        .orElseThrow(() -> NotFoundException.forEntity("Booking", id));
        
    bookingMapper.updateEntityFromDto(entity, request);  // CORRECT - use mapper
    var saved = bookingRepository.save(entity);
    
    log.debug("Updated booking with id: {}", saved.getId());
    return bookingMapper.toResponseDto(saved);
}
```

---

## Required Imports

```java
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.MappingTarget;
import org.mapstruct.NullValuePropertyMappingStrategy;
import org.mapstruct.ReportingPolicy;
```

**Note:** Do NOT use wildcard import `import org.mapstruct.*;`

---

## @Mapper Annotation Parameters (ALL REQUIRED)

| Parameter | Value | Purpose |
|-----------|-------|---------|
| `componentModel` | `"spring"` | Spring DI integration |
| `unmappedTargetPolicy` | `ReportingPolicy.IGNORE` | Ignore unmapped fields |
| `nullValuePropertyMappingStrategy` | `NullValuePropertyMappingStrategy.IGNORE` | Skip null values in updates |

---

## Mandatory Methods (ALL 3 REQUIRED)

### 1. toResponseDto
Converts entity to response DTO for API output.

### 2. toEntity
Converts create request DTO to new entity.
- Must ignore: `id`, `createdAt`, `updatedAt`, `version`
- Set default status: `@Mapping(target = "status", constant = "PENDING")`

### 3. updateEntityFromDto
Updates existing entity from update request DTO.
- Must ignore: `id`, `createdAt`, `updatedAt`, `version`
- Must ignore immutable business fields (e.g., `customerId`)
- Uses `@MappingTarget` annotation

---

## Custom Mapping Examples

### Nested Object Mapping
```java
@Mapper(
    componentModel = "spring",
    unmappedTargetPolicy = ReportingPolicy.IGNORE,
    nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE,
    uses = {AddressMapper.class}
)
public interface UserMapper {
    
    @Mapping(source = "address", target = "addressDto")
    UserResponseDto toResponseDto(User user);
}
```

### Expression Mapping
```java
@Mapping(target = "fullName", expression = "java(user.getFirstName() + \" \" + user.getLastName())")
UserResponseDto toResponseDto(User user);
```

---

## Checklist Before Generating Mapper

- [ ] All 3 @Mapper parameters included
- [ ] All 3 methods defined (toResponseDto, toEntity, updateEntityFromDto)
- [ ] Audit fields ignored in toEntity and updateEntityFromDto
- [ ] Immutable fields ignored in updateEntityFromDto
- [ ] Default status set in toEntity
- [ ] Individual imports used (no wildcard)
