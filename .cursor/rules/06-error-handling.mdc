---
description: Error handling standards - MANDATORY
globs: 
alwaysApply: true
---

# Error Handling Standards - MANDATORY

> **PRIORITY: HIGH** - Exception patterns shown here are MANDATORY.

## ⛔ FORBIDDEN Exception Usage

```java
// ❌ WRONG - Direct constructor without entity context
throw new NotFoundException("Booking not found");

// ❌ WRONG - Generic exception message
throw new RuntimeException("Error occurred");
```

## ✅ MANDATORY Exception Usage

```java
// ✅ CORRECT - Use forEntity() factory method
throw NotFoundException.forEntity("Booking", id);

// This produces: "Booking not found with id: 123"
```

---

## NotFoundException Template (COPY EXACTLY)

```java
package com.vtrip.{servicename}.exception;

/**
 * Exception thrown when an entity is not found.
 * MANDATORY: Use forEntity() factory method in services.
 */
public class NotFoundException extends RuntimeException {

    public NotFoundException(String message) {
        super(message);
    }

    /**
     * Factory method for entity not found errors.
     * 
     * @param entityName The name of the entity (e.g., "Booking", "User")
     * @param id The ID that was not found
     * @return NotFoundException with formatted message
     */
    public static NotFoundException forEntity(String entityName, Long id) {
        return new NotFoundException(entityName + " not found with id: " + id);
    }
}
```

---

## Service Usage Pattern (MANDATORY)

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class BookingServiceImpl implements BookingService {

    @Override
    @Transactional(readOnly = true)
    public BookingResponseDto getById(Long id) {
        return bookingRepository.findById(id)
            .map(bookingMapper::toResponseDto)
            .orElseThrow(() -> NotFoundException.forEntity("Booking", id));  // CORRECT
    }

    @Override
    @Transactional
    public BookingResponseDto update(Long id, UpdateBookingRequestDto request) {
        var entity = bookingRepository.findById(id)
            .orElseThrow(() -> NotFoundException.forEntity("Booking", id));  // CORRECT
        
        bookingMapper.updateEntityFromDto(entity, request);
        var saved = bookingRepository.save(entity);
        return bookingMapper.toResponseDto(saved);
    }

    @Override
    @Transactional
    public void delete(Long id) {
        if (!bookingRepository.existsById(id)) {
            throw NotFoundException.forEntity("Booking", id);  // CORRECT
        }
        bookingRepository.deleteById(id);
    }
}
```

---

## Exception Hierarchy (Reference)

```
BusinessException (abstract)
├── ValidationException
├── NotFoundException
├── DuplicateException
├── UnauthorizedException
├── ForbiddenException
└── IntegrationException
    ├── ServiceUnavailableException
    └── TimeoutException
```

## Base Exception Class (for full implementation)

```java
@Getter
public abstract class BusinessException extends RuntimeException {
    private final String errorCode;
    private final HttpStatus httpStatus;
    
    protected BusinessException(String message, String errorCode, HttpStatus httpStatus) {
        super(message);
        this.errorCode = errorCode;
        this.httpStatus = httpStatus;
    }
}
```

## Global Exception Handler

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(NotFoundException.class)
    public ResponseEntity<ErrorResponse> handleNotFoundException(NotFoundException ex) {
        log.error("Not found exception: {}", ex.getMessage());
        
        return ResponseEntity
            .status(HttpStatus.NOT_FOUND)
            .body(ErrorResponse.builder()
                .code("NOT_FOUND")
                .message(ex.getMessage())
                .timestamp(Instant.now())
                .build());
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(
            MethodArgumentNotValidException ex) {
        
        List<FieldError> errors = ex.getBindingResult()
            .getFieldErrors()
            .stream()
            .map(e -> new FieldError(e.getField(), e.getDefaultMessage()))
            .toList();
            
        return ResponseEntity
            .badRequest()
            .body(ErrorResponse.builder()
                .code("VALIDATION_ERROR")
                .message("Validation failed")
                .errors(errors)
                .timestamp(Instant.now())
                .build());
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGenericException(Exception ex) {
        log.error("Unexpected error", ex);
        
        return ResponseEntity
            .internalServerError()
            .body(ErrorResponse.builder()
                .code("INTERNAL_ERROR")
                .message("An unexpected error occurred")
                .timestamp(Instant.now())
                .build());
    }
}
```

## Error Response Format

```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ErrorResponse {
    private String code;
    private String message;
    private Instant timestamp;
    private List<FieldError> errors;
    private String traceId;
}

@Data
@AllArgsConstructor
public class FieldError {
    private String field;
    private String message;
}
```

---

## Checklist Before Generating Exception Code

- [ ] NotFoundException has `forEntity()` factory method
- [ ] Services use `forEntity()` not direct constructor
- [ ] Exception message includes entity name and ID
- [ ] Delete operations check `existsById` before throwing
